image: Visual Studio 2015

environment:
  BASH: C:\cygwin64\bin\bash
  PYTHON: c:\Python35 # No trailing backslash
  CYG_PYTHON_PATH: /cygdrive/c/Python35:/cygdrive/c/Python35/Scripts # Need to override /usr/bin

platform: x64

cache:
  - app\node_modules        # local npm modules
  - '%APPDATA%\npm-cache'   # npm cache
    
init:
  - set PATH=%PYTHON%;%PYTHON%\Scripts;%PATH% # Activate Python 3.5
  - git config --global core.autocrlf true

install:
  - ps: Install-Product node 6.11.0 x64
  - '%BASH% -lc "export PATH=$CYG_PYTHON_PATH:$PATH && echo $PATH && which python && which pip"'
  - '%BASH% -lc "export PATH=$CYG_PYTHON_PATH:$PATH && cd $APPVEYOR_BUILD_FOLDER/api && make install"'
  - '%BASH% -lc "cd $APPVEYOR_BUILD_FOLDER/app && make install"'

build: false # No need to run MSBuild

build_script:
  - '%BASH% -lc "export PATH=$CYG_PYTHON_PATH:$PATH && cd $APPVEYOR_BUILD_FOLDER/api && make test exe"'
  - '%BASH% -lc "cd $APPVEYOR_BUILD_FOLDER && source scripts/env-vars-appveyor && cd app && make -j 2 build && make test package"'
  - >
    %BASH% -lc "cd $APPVEYOR_BUILD_FOLDER/app/dist && ls -la . && find ./** ! -name 'opentrons-v*' -exec rm -rf {} + && ls -la ."

before_deploy:
  - ps: Get-ChildItem .\app\dist\*
  - ps: Get-ChildItem .\app-shell\releases\* | % { Push-AppveyorArtifact $_.FullName -FileName $_.Name -DeploymentName OTAppWin}

deploy:
  - provider: S3
    access_key_id: $(AWS_ACCESS_KEY)
    secret_access_key: $(AWS_SECRET_KEY)
    bucket: ot-app-builds
    set_public: true
    folder: win
    artifact: OTAppWin
